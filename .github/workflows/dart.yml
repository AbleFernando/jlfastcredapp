name: iOS-ipa-build

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: üéâ iOS Build
    runs-on: macos-latest
    steps:
      # Checkout do reposit√≥rio
      - uses: actions/checkout@v3

      # Clone o reposit√≥rio do pacote jlfastcred_core
      - name: Clone jlfastcred_core
        run: git clone https://github.com/AbleFernando/jlfastcredcore.git ./jlfastcredcore

      # Configura√ß√£o do Flutter (usando a a√ß√£o oficial)
      - name: Setup Flutter 2.10.5
        uses: subosito/flutter-action@v2
        with:
          flutter_version: '2.10.5'
          channel: 'stable'

      # Ajuste de permiss√µes no diret√≥rio iOS
      - name: Set folder permissions
        run: chmod -R 777 ios

      # Instalar depend√™ncias do Flutter no diret√≥rio do core
      - name: Install Flutter dependencies in jlfastcredcore
        run: |
          cd ./jlfastcredcore
          flutter clean
          flutter pub get

      # Instalar depend√™ncias do Flutter no diret√≥rio do app
      - name: Install Flutter dependencies in app
        run: |
          cd ../
          flutter clean
          flutter pub get    

      # Validar e configurar CocoaPods para o plugin jlfastcred
      - name: Validate CocoaPods and configure plugin
        run: |
          # Garantir que as depend√™ncias Flutter sejam instaladas
          flutter pub get
      
          cd ios
          if [ ! -f "Podfile" ]; then
            echo "No Podfile found, initializing CocoaPods..."
            pod init
          fi
      
          # For√ßar a inclus√£o do plugin jlfastcred no Podfile
          if ! grep -q "jlfastcred" Podfile; then
            echo "Adding jlfastcred to Podfile..."
            echo "pod 'jlfastcred', :path => '../.symlinks/plugins/jlfastcred/ios'" >> Podfile
          fi
      
          # Atualizar reposit√≥rio CocoaPods e instalar depend√™ncias
          pod repo update
          pod install

      # Verificar se o diret√≥rio existe antes de tentar aplicar permiss√µes
      - name: Check if Flutter.framework exists
        run: |
          if [ -d "build/ios/Release-iphoneos/Flutter.framework" ]; then
            echo "Flutter.framework exists, setting permissions..."
            sudo chmod -R 777 build/ios/Release-iphoneos/Flutter.framework
          else
            echo "Flutter.framework does not exist, skipping chmod."
          fi

      # Build para iOS no modo release
      - name: Build iOS Release
        run: flutter build ios --release --no-codesign

      # Criar a pasta Payload para o IPA
      - name: Create Payload directory
        run: mkdir -p Payload
        working-directory: build/ios/iphoneos

      # Ajustar permiss√µes da Payload
      - name: Set Payload folder permissions
        run: chmod -R 777 Payload
        working-directory: build/ios/iphoneos

      # Mover Runner.app para Payload
      - name: Move Runner.app to Payload
        run: mv Runner.app Payload/
        working-directory: build/ios/iphoneos

      # Empacotar a pasta Payload em um arquivo IPA
      - name: Create IPA archive
        run: zip -qq -r -9 FlutterIpaExport.ipa Payload
        working-directory: build/ios/iphoneos

      # Fazer upload do IPA para a release
      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/ios/iphoneos/FlutterIpaExport.ipa
          tag: v1.0
          overwrite: true
          body: "This is the first release"
