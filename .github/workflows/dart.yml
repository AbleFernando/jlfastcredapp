name: iOS-ipa-build

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: üéâ iOS Build
    runs-on: macos-latest
    steps:
      # Checkout do reposit√≥rio
      - uses: actions/checkout@v3

      # Clone o reposit√≥rio do pacote jlfastcred_core
      - name: Clone jlfastcred_core
        run: git clone https://github.com/AbleFernando/jlfastcred_core.git ./jlfastcred_core

      # Configura√ß√£o do Flutter (usando a a√ß√£o oficial)
      - name: Setup Flutter 2.10.5
        uses: subosito/flutter-action@v2
        with:
          flutter_version: '2.10.5'
          channel: 'stable'

      # Verificar as vers√µes do Flutter e Dart
      - name: Check Flutter and Dart versions
        run: |
          flutter --version
          dart --version

      # Ajuste de permiss√µes no diret√≥rio iOS
      - name: Set folder permissions
        run: chmod -R 777 ios

      # Limpar build anterior para evitar conflitos
      - name: Clean previous builds
        run: flutter clean

      # Instalar depend√™ncias do Flutter
      - run: flutter pub get

      # Atualizar CocoaPods
      - name: Update CocoaPods repository
        run: pod repo update
        working-directory: ios

      # Configura√ß√£o de permiss√µes para o diret√≥rio Flutter.framework
      - name: Set permissions for Flutter.framework
        run: sudo chmod -R 777 /Users/runner/work/jlfastcredapp/jlfastcredapp/build/ios/Release-iphoneos/Flutter.framework

      # Build para iOS no modo release
      - name: Build iOS Release
        run: flutter build ios --release --no-codesign

      # Criar a pasta Payload para o IPA
      - name: Create Payload directory
        run: mkdir -p Payload
        working-directory: build/ios/iphoneos

      # Mover Runner.app para Payload
      - name: Move Runner.app to Payload
        run: mv Runner.app Payload/
        working-directory: build/ios/iphoneos

      # Ajustar permiss√µes da Payload
      - name: Set Payload folder permissions
        run: chmod -R 777 Payload
        working-directory: build/ios/iphoneos

      # Empacotar a pasta Payload em um arquivo IPA
      - name: Create IPA archive
        run: zip -qq -r -9 FlutterIpaExport.ipa Payload
        working-directory: build/ios/iphoneos

      # Fazer upload do IPA para a release
      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/ios/iphoneos/FlutterIpaExport.ipa
          tag: v1.0
          overwrite: true
          body: "This is the first release"
